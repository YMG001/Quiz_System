{% extends "base.html" %}

{% block title %}Quiz System - ç­”é¢˜{% endblock %}

{% block extra_style %}
<style>
    .container {
        max-width: 900px;
        margin: 0 auto;
        padding: 20px;
    }

    /* æ–‡ä»¶ä¸Šä¼ åŒºåŸŸæ ·å¼ */
    .upload-section {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 30px;
    }

    .upload-section h2 {
        font-size: 18px;
        color: #495057;
        margin: 0 0 10px 0;
    }

    .upload-form {
        display: flex;
        flex-direction: column;
        gap: 20px;
    }

    .upload-form input[type="file"] {
        flex: 1;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
    }

    .upload-form button {
        padding: 8px 16px;
        background-color: #4A90E2;
        color: white;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        transition: background-color 0.3s;
    }

    .upload-form button:hover {
        background-color: #357ABD;
    }

    /* ç­”é¢˜åŒºåŸŸæ ·å¼ */
    .quiz-section {
        background: white;
        border-radius: 12px;
        box-shadow: 0 2px 8px rgba(0, 0, 0, 0.1);
        padding: 30px;
        min-height: 400px;
    }

    .quiz-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 20px;
        padding-bottom: 15px;
        border-bottom: 1px solid #e9ecef;
    }

    .quiz-header h2 {
        font-size: 24px;
        color: #333;
        margin: 0;
    }

    .progress-info {
        color: #6c757d;
        font-size: 16px;
    }

    .question-card {
        display: none;
        opacity: 0;
        transform: translateY(20px);
        transition: opacity 0.3s, transform 0.3s;
    }

    .question-card.active {
        display: block;
        opacity: 1;
        transform: translateY(0);
    }

    .question-content {
        margin-bottom: 25px;
    }

    .question-content h3 {
        font-size: 20px;
        color: #333;
        margin: 0 0 20px 0;
        line-height: 1.4;
    }

    .answer {
        background: #f8f9fa;
        padding: 20px;
        border-radius: 8px;
        margin-bottom: 20px;
        display: none;
    }

    .controls {
        display: flex;
        gap: 12px;
        justify-content: flex-end;
    }

    .control-btn {
        padding: 10px 20px;
        border: none;
        border-radius: 6px;
        cursor: pointer;
        font-weight: 500;
        transition: all 0.3s;
    }

    .show-answer-btn {
        background-color: #6c757d;
        color: white;
    }

    .show-answer-btn:hover {
        background-color: #5a6268;
    }

    .next-btn {
        background-color: #4A90E2;
        color: white;
    }

    .next-btn:hover {
        background-color: #357ABD;
    }

    .empty-state {
        text-align: center;
        padding: 40px 20px;
        color: #6c757d;
    }

    .empty-state p {
        font-size: 18px;
        margin-bottom: 20px;
    }

    /* é”®ç›˜å¿«æ·é”®æç¤º */
    .keyboard-shortcuts {
        margin-top: 20px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 8px;
        font-size: 14px;
        color: #6c757d;
    }

    .keyboard-shortcuts h3 {
        margin: 0 0 10px 0;
        font-size: 16px;
        color: #495057;
    }

    .shortcuts-list {
        display: flex;
        gap: 20px;
    }

    .shortcut-item {
        display: flex;
        align-items: center;
        gap: 8px;
    }

    .key {
        background: #e9ecef;
        padding: 2px 6px;
        border-radius: 4px;
        font-family: monospace;
    }

    .form-group {
        margin-bottom: 15px;
    }

    .form-group label {
        display: block;
        margin-bottom: 5px;
        font-weight: 500;
        color: #495057;
    }

    .form-group select {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: white;
    }

    .form-group input[type="file"] {
        width: 100%;
        padding: 8px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        background-color: white;
    }

    .upload-form button {
        background-color: #4A90E2;
        color: white;
        padding: 10px 20px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-weight: 500;
    }

    .upload-form button:hover {
        background-color: #357ABD;
    }

    /* æ¨¡å‹è®¾ç½®ç›¸å…³æ ·å¼ */
    .model-settings {
        padding: 10px;
        border: 1px solid #e9ecef;
        border-radius: 4px;
        margin-top: 10px;
    }

    /* æ·»åŠ ä¸€äº›åŠ¨ç”»æ•ˆæœ */
    .form-group select,
    .form-group input[type="file"] {
        transition: border-color 0.3s;
    }

    .form-group select:focus,
    .form-group input[type="file"]:focus {
        border-color: #4A90E2;
        outline: none;
    }

    /* æ¨¡å‹é€‰æ‹©åŒºåŸŸæ ·å¼ */
    .model-selection {
        background: white;
        padding: 20px;
        border-radius: 8px;
        border: 1px solid #e9ecef;
    }

    .model-type-buttons {
        display: flex;
        gap: 10px;
        margin-bottom: 20px;
    }

    .model-type-buttons input[type="radio"] {
        display: none;
    }

    .model-btn {
        flex: 1;
        padding: 10px 15px;
        text-align: center;
        background: #f8f9fa;
        border: 2px solid #e9ecef;
        border-radius: 6px;
        cursor: pointer;
        transition: all 0.3s ease;
        font-weight: 500;
    }

    .model-type-buttons input[type="radio"]:checked+.model-btn {
        background: #4A90E2;
        color: white;
        border-color: #4A90E2;
    }

    .local-model-input,
    .jiutian-model-input {
        background: #f8f9fa;
        padding: 15px;
        border-radius: 6px;
        border: 1px solid #e9ecef;
        margin-top: 15px;
    }

    .local-model-input input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .local-model-input input[type="text"]:focus {
        border-color: #4A90E2;
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .model-hint {
        margin-top: 8px;
        font-size: 12px;
        color: #6c757d;
    }

    .tooltip-icon {
        display: inline-block;
        width: 16px;
        height: 16px;
        background: #e9ecef;
        border-radius: 50%;
        text-align: center;
        line-height: 16px;
        font-size: 12px;
        color: #495057;
        cursor: help;
        margin-left: 5px;
    }

    .form-actions {
        margin-top: 20px;
        text-align: center;
    }

    .submit-btn {
        display: inline-flex;
        align-items: center;
        gap: 8px;
        padding: 12px 24px;
        background: #4A90E2;
        color: white;
        border: none;
        border-radius: 6px;
        font-size: 16px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.3s ease;
    }

    .submit-btn:hover {
        background: #357ABD;
        transform: translateY(-1px);
    }

    .btn-icon {
        font-size: 20px;
    }

    /* å“åº”å¼å¸ƒå±€ */
    @media (max-width: 768px) {
        .model-type-buttons {
            flex-direction: column;
        }

        .model-btn {
            width: 100%;
        }
    }

    .jiutian-model-input {
        margin-top: 15px;
        padding: 15px;
        background: #f8f9fa;
        border-radius: 6px;
        border: 1px solid #e9ecef;
    }

    .jiutian-model-input select {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        transition: border-color 0.3s;
    }

    .jiutian-model-input select:focus {
        border-color: #4A90E2;
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .api-key-section {
        margin-top: 15px;
        padding-top: 15px;
        border-top: 1px solid #e9ecef;
    }

    .api-key-section input[type="password"],
    .api-key-section input[type="text"] {
        width: 100%;
        padding: 10px;
        border: 1px solid #ced4da;
        border-radius: 4px;
        font-size: 14px;
        margin-top: 5px;
        transition: border-color 0.3s;
    }

    .api-key-section input:focus {
        border-color: #4A90E2;
        outline: none;
        box-shadow: 0 0 0 3px rgba(74, 144, 226, 0.1);
    }

    .show-hide-key {
        margin-top: 8px;
        display: flex;
        align-items: center;
        gap: 5px;
    }

    .show-hide-key input[type="checkbox"] {
        margin: 0;
    }

    .show-hide-key label {
        font-size: 12px;
        color: #6c757d;
        cursor: pointer;
    }

    /* æ·»åŠ é”™è¯¯çŠ¶æ€æ ·å¼ */
    .api-key-section input.error {
        border-color: #dc3545;
    }

    .error-message {
        color: #dc3545;
        font-size: 12px;
        margin-top: 5px;
        display: none;
    }
</style>
{% endblock %}

{% block content %}
<div class="container">
    <form class="upload-form" action="{{ url_for('api.upload_file') }}" method="post" enctype="multipart/form-data">
        <!-- æ–‡ä»¶ä¸Šä¼ åŒºåŸŸ -->
        <div class="file-upload-section">
            <h2>ä¸Šä¼ å­¦ä¹ èµ„æ–™</h2>
            <div class="form-group">
                <label for="file">é€‰æ‹©æ–‡ä»¶ï¼š</label>
                <input type="file" name="file" id="file" accept=".txt,.pdf,.docx" required>
            </div>
        </div>

        <!-- æ¨¡å‹é€‰æ‹©åŒºåŸŸ -->
        <div class="model-selection">
            <div class="form-group">
                <label>é€‰æ‹©æ¨¡å‹ç±»å‹ï¼š</label>
                <div class="model-type-buttons">
                    <input type="radio" id="local" name="model_type" value="local" checked>
                    <label for="local" class="model-btn">æœ¬åœ°æ¨¡å‹ (Ollama)</label>

                    <input type="radio" id="jiutian" name="model_type" value="jiutian">
                    <label for="jiutian" class="model-btn">ä¹å¤©å¤§æ¨¡å‹</label>

                    <input type="radio" id="openai" name="model_type" value="openai">
                    <label for="openai" class="model-btn">OpenAI</label>
                </div>
            </div>

            <!-- æœ¬åœ°æ¨¡å‹è®¾ç½® -->
            <div class="local-model-input">
                <label for="local_model">
                    Ollama æ¨¡å‹åç§°ï¼š
                    <span class="tooltip-icon" title="è¾“å…¥å·²å®‰è£…çš„ Ollama æ¨¡å‹åç§°ï¼Œä¾‹å¦‚ï¼šqwen2:1.5b, mistral, codellama ç­‰">?</span>
                </label>
                <input type="text" id="local_model" name="local_model" placeholder="ä¾‹å¦‚ï¼šqwen2:1.5b, mistral, codellama"
                    value="qwen2:1.5b">
                <div class="model-hint">å¸¸ç”¨æ¨¡å‹ï¼šqwen2:1.5b, mistral, codellama, neural-chat</div>
            </div>

            <!-- ä¹å¤©æ¨¡å‹è®¾ç½® -->
            <div class="jiutian-model-input" style="display: none;">
                <!-- ä¿æŒåŸæœ‰å†…å®¹ä¸å˜ -->
                <label for="jiutian_model">
                    é€‰æ‹©ä¹å¤©æ¨¡å‹ï¼š
                    <span class="tooltip-icon" title="é€‰æ‹©ä¹å¤©å¹³å°æä¾›çš„å¤§è¯­è¨€æ¨¡å‹">?</span>
                </label>
                <select id="jiutian_model" name="jiutian_model">
                    <option value="llama3-70b">Llama 3.1-70B</option>
                    <option value="jiutian-qianwen">ä¹å¤©åƒé—®</option>
                </select>
                <div class="model-hint">å¯é€‰æ‹© Llama 3.1-70B æˆ– ä¹å¤©åƒé—®ç­‰é«˜æ€§èƒ½æ¨¡å‹</div>

                <div class="api-key-section">
                    <label for="jiutian_api_key">
                        API Keyï¼š
                        <span class="tooltip-icon" title="è¾“å…¥æ‚¨çš„ä¹å¤©å¹³å° API Keyï¼Œç”¨äºæ¥å£è°ƒç”¨é‰´æƒ">?</span>
                    </label>
                    <input type="password" id="jiutian_api_key" name="jiutian_api_key" placeholder="è¯·è¾“å…¥æ‚¨çš„ä¹å¤©å¹³å° API Key"
                        required>
                    <div class="show-hide-key">
                        <input type="checkbox" id="show_key">
                        <label for="show_key">æ˜¾ç¤º API Key</label>
                    </div>
                    <div class="model-hint">è¯·å¦¥å–„ä¿ç®¡æ‚¨çš„ API Keyï¼Œä¸è¦æ³„éœ²ç»™ä»–äºº</div>
                </div>
            </div>
        </div>

        <!-- æäº¤æŒ‰é’® -->
        <div class="form-actions">
            <button type="submit" class="submit-btn">
                <span class="btn-icon">ğŸ“¤</span>
                <span class="btn-text">ä¸Šä¼ å¹¶ç”Ÿæˆé¢˜ç›®</span>
            </button>
        </div>
    </form>

    <!-- ç­”é¢˜åŒºåŸŸ -->
    <div class="quiz-section">
        {% if questions %}
        <div class="quiz-header">
            <h2>ç»ƒä¹ é¢˜</h2>
            <div class="progress-info">
                é¢˜ç›® <span id="current-question">1</span> / <span id="total-questions">{{ questions|length }}</span>
            </div>
        </div>

        <div id="questions-container">
            {% for qa in questions %}
            <div class="question-card" data-index="{{ loop.index0 }}">
                <div class="question-content">
                    <h3>{{ qa.question }}</h3>
                    <div class="answer">
                        {{ qa.answer }}
                    </div>
                </div>
                <div class="controls">
                    <button class="control-btn show-answer-btn" onclick="toggleAnswer(this)">æ˜¾ç¤ºç­”æ¡ˆ</button>
                    <button class="control-btn next-btn" onclick="nextQuestion()">ä¸‹ä¸€é¢˜</button>
                </div>
            </div>
            {% endfor %}
        </div>

        <div class="keyboard-shortcuts">
            <h3>é”®ç›˜å¿«æ·é”®</h3>
            <div class="shortcuts-list">
                <div class="shortcut-item">
                    <span class="key">ç©ºæ ¼</span>
                    <span>ä¸‹ä¸€é¢˜</span>
                </div>
                <div class="shortcut-item">
                    <span class="key">Enter</span>
                    <span>æ˜¾ç¤º/éšè—ç­”æ¡ˆ</span>
                </div>
            </div>
        </div>
        {% else %}
        <div class="empty-state">
            <p>è¿˜æ²¡æœ‰é¢˜ç›®ï¼Œè¯·å…ˆä¸Šä¼ å­¦ä¹ èµ„æ–™</p>
        </div>
        {% endif %}
    </div>
</div>

<script>
    let currentIndex = 0;
    const questions = document.querySelectorAll('.question-card');
    const totalQuestions = questions.length;

    function showQuestion(index) {
        questions.forEach(q => {
            q.classList.remove('active');
            const answer = q.querySelector('.answer');
            if (answer) answer.style.display = 'none';
        });

        if (questions[index]) {
            questions[index].classList.add('active');
            document.getElementById('current-question').textContent = index + 1;

            // é‡ç½®æŒ‰é’®æ–‡æœ¬
            const button = questions[index].querySelector('.show-answer-btn');
            if (button) button.textContent = 'æ˜¾ç¤ºç­”æ¡ˆ';
        }
    }

    function toggleAnswer(button) {
        const card = button.closest('.question-card');
        const answer = card.querySelector('.answer');

        if (answer.style.display === 'none' || !answer.style.display) {
            answer.style.display = 'block';
            button.textContent = 'éšè—ç­”æ¡ˆ';
        } else {
            answer.style.display = 'none';
            button.textContent = 'æ˜¾ç¤ºç­”æ¡ˆ';
        }
    }

    function nextQuestion() {
        if (currentIndex < totalQuestions - 1) {
            currentIndex++;
            showQuestion(currentIndex);
        } else {
            if (confirm('å·²å®Œæˆæ‰€æœ‰é¢˜ç›®ï¼Œæ˜¯å¦é‡æ–°å¼€å§‹ï¼Ÿ')) {
                currentIndex = 0;
                showQuestion(currentIndex);
            }
        }
    }

    // åˆå§‹åŒ–æ˜¾ç¤ºç¬¬ä¸€é¢˜
    if (totalQuestions > 0) {
        showQuestion(0);
    }

    // é”®ç›˜å¿«æ·é”®
    document.addEventListener('keydown', function (event) {
        if (event.key === ' ' || event.key === 'ArrowRight') {
            event.preventDefault();
            nextQuestion();
        } else if (event.key === 'Enter') {
            event.preventDefault();
            const currentCard = document.querySelector('.question-card.active');
            if (currentCard) {
                const button = currentCard.querySelector('.show-answer-btn');
                toggleAnswer(button);
            }
        }
    });

    document.addEventListener('DOMContentLoaded', function () {
        const modelTypeInputs = document.querySelectorAll('input[name="model_type"]');
        const localModelInput = document.querySelector('.local-model-input');
        const jiutianModelInput = document.querySelector('.jiutian-model-input');

        function updateModelInput() {
            const selectedType = document.querySelector('input[name="model_type"]:checked').value;
            localModelInput.style.display = 'none';
            jiutianModelInput.style.display = 'none';

            switch (selectedType) {
                case 'local':
                    localModelInput.style.display = 'block';
                    break;
                case 'jiutian':
                    jiutianModelInput.style.display = 'block';
                    break;
                case 'openai':
                    // OpenAI ä¸éœ€è¦é¢å¤–çš„è¾“å…¥æ¡†
                    break;
            }
        }

        modelTypeInputs.forEach(input => {
            input.addEventListener('change', updateModelInput);
        });

        updateModelInput(); // åˆå§‹åŒ–æ˜¾ç¤ºçŠ¶æ€

        // æ·»åŠ å·¥å…·æç¤º
        const tooltips = document.querySelectorAll('.tooltip-icon');
        tooltips.forEach(tooltip => {
            tooltip.addEventListener('mouseover', function (e) {
                const title = this.getAttribute('title');
                if (!title) return;

                // åˆ›å»ºå·¥å…·æç¤ºå…ƒç´ 
                const tooltipEl = document.createElement('div');
                tooltipEl.className = 'tooltip';
                tooltipEl.textContent = title;
                document.body.appendChild(tooltipEl);

                // å®šä½å·¥å…·æç¤º
                const rect = this.getBoundingClientRect();
                tooltipEl.style.position = 'absolute';
                tooltipEl.style.top = rect.top - tooltipEl.offsetHeight - 5 + 'px';
                tooltipEl.style.left = rect.left + (rect.width - tooltipEl.offsetWidth) / 2 + 'px';

                // ç§»é™¤titleå±æ€§ä»¥é¿å…åŸç”Ÿå·¥å…·æç¤º
                this.removeAttribute('title');

                // ç§»é™¤å·¥å…·æç¤º
                this.addEventListener('mouseout', function () {
                    tooltipEl.remove();
                    this.setAttribute('title', title);
                }, { once: true });
            });
        });

        // API Key æ˜¾ç¤º/éšè—åŠŸèƒ½
        const showKeyCheckbox = document.getElementById('show_key');
        const apiKeyInput = document.getElementById('jiutian_api_key');

        if (showKeyCheckbox && apiKeyInput) {
            showKeyCheckbox.addEventListener('change', function () {
                apiKeyInput.type = this.checked ? 'text' : 'password';
            });
        }

        // API Key æœ¬åœ°å­˜å‚¨åŠŸèƒ½
        const savedApiKey = localStorage.getItem('jiutian_api_key');
        if (savedApiKey && apiKeyInput) {
            apiKeyInput.value = savedApiKey;
        }

        // ä¿å­˜ API Key åˆ°æœ¬åœ°å­˜å‚¨
        const uploadForm = document.querySelector('.upload-form');
        if (uploadForm) {
            uploadForm.addEventListener('submit', function (e) {
                const apiKey = apiKeyInput.value;
                if (apiKey) {
                    localStorage.setItem('jiutian_api_key', apiKey);
                }
            });
        }

        // API Key éªŒè¯
        function validateApiKey(apiKey) {
            return apiKey && apiKey.length >= 32; // å‡è®¾ API Key è‡³å°‘éœ€è¦ 32 ä½
        }

        if (apiKeyInput) {
            apiKeyInput.addEventListener('input', function () {
                const errorMessage = this.parentElement.querySelector('.error-message');
                if (!validateApiKey(this.value)) {
                    this.classList.add('error');
                    if (errorMessage) {
                        errorMessage.style.display = 'block';
                    }
                } else {
                    this.classList.remove('error');
                    if (errorMessage) {
                        errorMessage.style.display = 'none';
                    }
                }
            });
        }
    });
</script>
{% endblock %}